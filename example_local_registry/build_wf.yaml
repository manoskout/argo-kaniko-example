apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: container-image-
spec:
  entrypoint: wf-test
  imagePullSecrets:
  - name: regcred
  serviceAccountName: argo

  volumes:
    - name: kaniko-secret
      secret:
        secretName: regcred
        items:
          - key: .dockerconfigjson
            path: config.json
    - name: dockerfile-storage
      persistentVolumeClaim:
        claimName: dockerfile-claim

  templates:
  - name: wf-test
    dag:
      tasks:
        - name: build-first-image
          templateRef: 
            name: container-creation-template
            template: build-kaniko-image
          arguments:
            parameters:
            - name: dockerfile
              value: "dockerfile"
            - name: context
              value: "dir://workspace"
            - name: image-name
              value: 192.168.1.20:5000/kaniko-test # i.e.  manoskoutoulakis/test
            - name: image-tag
              value: latest
        - name: build-second-image
          templateRef: 
            name: container-creation-template
            template: build-kaniko-image
          arguments:
            parameters:
            - name: dockerfile
              value: "dockerfile1"
            - name: context
              value: "dir://workspace"
            - name: image-name
              value: 192.168.1.20:5000/kaniko-test-2 # i.e. manoskoutoulakis/secondtest
            - name: image-tag
              value: latest
        - name: test-first-image
          dependencies: [build-first-image]
          templateRef: 
            name: container-creation-template
            template: test-image
          arguments:
            parameters:
            - name: image-name
              value: 192.168.1.20:5000/kaniko-test # i.e. manoskoutoulakis/test
            - name: msg
              value:  "Hello from the first image"
        - name: test-second-image
          dependencies: [build-second-image]
          templateRef: 
            name: container-creation-template
            template: test-image
          arguments:
            parameters:
            - name: image-name
              value: 192.168.1.20:5000/kaniko-test-2 # i.e. manoskoutoulakis/secondtest
            - name: msg
              value:  "Hello from the second image"
  #       - name: check-image
  #         depends: "build-container-image"
  #         template: echo
  #         arguments:
  #           parameters:
  #           - name: message
  #             value: Checking...
  #           - name: image-name
  #             value: manoskoutoulakis/test #<your_image_name> # i.e.
  #           - name: image-tag
  #             value: latest
